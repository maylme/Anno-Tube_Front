<!--
    Page of the playing video (youtube or annoted one)
    By: Corentin Hardy & Nicolas Forget
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../components/video-display.html">
<link rel="import" href="../components/video-info.html">
<link rel="import" href="../components/video-comment.html">
<link rel="import" href="./shared-styles.html">


<dom-module id="annotube-video">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }
            
            video-display {
                position: relative;
                width: 100%;
            }
            
            video-comment {
                position: relative;
                width: 60%;
            }
            
            .playing_aera {
                width: 100%;
                display: inline-flex;
                padding-bottom: 10px;
                border-bottom: dashed 1px lightgrey;
                position: relative;
            }
            
            .video_part {
                width: 60%;
                display: inline-block;
                margin: 0;
                padding: 0;
            }
            
            .link_part {
                width: 40%;
                margin: 0;
                padding: 15px;
            }
            
            .link_part div {
                border: solid grey 1px;
            }
        </style>


        <iron-ajax id="ajax" url="https://www.googleapis.com/youtube/v3/videos" params='{"part":"snippet", "key": "AIzaSyC9geJJJDJxUnFc6890jzFq9yBJsBEzJuU"}'
            handle-as="json" last-response="{{response}}" debounce-duration="300" on-response="youtubeResponse"></iron-ajax>

            <div class="card pd16">
                <h1>[[videoName]]</h1>
                <div class="playing_aera">
                    <div class="video_part">
                        <video-display class="video" video-id="{{youtubeId}}" annotations="{{annotations}}"></video-display>
                        <video-info author = "{author}}" video-id="{{videoId}}" annotations="{{annotations}}" is-youtube="{{isYoutube}}" youtube-id="{{youtubeId}}" video-name="{{videoName}}"  thumbnail="{{thumbnail}}"></video-info>
                    </div>

                    <div class="link_part ">
                        <div class="pd16 ">partie des liens wikipedia
                        </div>
                    </div>
                </div>


                <template is="dom-repeat " items="{{comments}} ">
                    <video-comment video-id="{{videoId}} " com-id="{{item._id}} " com-name="{{item.author.username}}
                            " com-pic=" " com-text="{{item.text}} "></video-comment>
                </template>
            </div>


    </template>

    <script>
        Polymer({
            is: 'annotube-video',

            properties: {
                videoId: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true
                },
                isYoutube: {
                    type: Boolean,
                    notify: true,
                    reflectToAttribute: true,
                    value: false
                },
                youtubeId: String,
                videoName: String,
                author: Object,
                annotations: Object,
                comments: Object,
                likes: Number,
                likeId: String,
                thumbnail: String,
            },
            ready: function () {
                this.isYoutube = (this.isYoutube=="true");
                if (!this.isYoutube) {
                    var that = this;
                    var url = "https://node.edouardg.fr/video/" + this.videoId;

                    var http = new XMLHttpRequest();
                    http.open("GET", url, true);
                    http.setRequestHeader("Content-type", "application/json; charset=utf-8");
                    http.withCredentials = true;
                    http.send();

                    http.onreadystatechange = function () {
                        if (http.readyState == 4) {
                            if (http.status == 200) {

                                var res = JSON.parse(http.response);
                                console.log("coco video", res);
                                that.youtubeId = res.youtube;
                                that.videoName = res.name;
                                that.author = res.author;
                                that.annotations = res.annotations;
                                that.comments = res.comments;
                                that.thumbnail = res.thunbmail;
                                that.likes;
                                that.likeId;

                            } else if (http.status == 400) {
                                alert(JSON.parse(http.responseText).message);
                            } else if (http.status == 500) {
                                console.log("The server has encountered a situation it doesn 't know how to handle.");
                            } else if (http.status == 401) {
                                document.location = "/forbidden";

                            }
                        }
                    }
                } else {
                    this.$.ajax.params.id = this.videoId;
                    this.$.ajax.generateRequest();
                    this.youtubeId = this.videoId;
                    this.videoId = "";
                    this.videoName = "";
                    this.author = "";
                    this.annotations = "";
                    this.comments = "";
                    this.likes;
                    this.likeId;
                }
            },
            youtubeResponse: function (result) {
                this.videoName = result.detail.response.items[0].snippet.title;
                this.thumbnail = result.detail.response.items[0].snippet.thumbnails.medium.url;
            }
        });
    </script>
</dom-module>